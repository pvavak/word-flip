<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word Flip ‚Äì EN‚ÜîSK tr√©ning (Mix)</title>
<style>
  :root{
    --bg:#0b1020;
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.60);
    --line:rgba(255,255,255,.12);
    --card:rgba(255,255,255,.06);
    --card2:rgba(255,255,255,.04);
    --good:rgba(34,197,94,.18);
    --bad:rgba(239,68,68,.18);
    --pri:rgba(99,102,241,.30);
    --shadow:0 18px 45px rgba(0,0,0,.30);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,0.35), transparent 60%),
      radial-gradient(1000px 600px at 85% 20%, rgba(16,185,129,0.22), transparent 60%),
      radial-gradient(900px 600px at 35% 95%, rgba(244,63,94,0.20), transparent 60%),
      var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    line-height:1.35;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .top{
    display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;align-items:flex-start;
    margin-bottom:14px;
  }
  h1{margin:0;font-size:26px;letter-spacing:.2px}
  .sub{margin-top:6px;color:var(--muted);font-size:13px}
  .pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .pill{
    padding:8px 10px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
    color:var(--muted);font-size:12px;
  }
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
    border:1px solid var(--line);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    padding:14px;
  }
  .card h2{
    margin:0 0 10px 0;
    font-size:14px;color:var(--muted);
    font-weight:600;letter-spacing:.4px;text-transform:uppercase;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input{
    background:rgba(255,255,255,0.06);
    border:1px solid var(--line);
    color:var(--text);
    border-radius:12px;
    padding:10px 12px;
    outline:none;
  }
  select:focus,input:focus{box-shadow:0 0 0 4px rgba(99,102,241,0.18);border-color:rgba(99,102,241,0.6)}
  .btn{
    background:rgba(255,255,255,0.10);
    border:1px solid var(--line);
    color:var(--text);
    padding:10px 12px;border-radius:12px;
    cursor:pointer;
    transition:transform .06s ease, background .15s ease;
    user-select:none;
  }
  .btn:hover{background:rgba(255,255,255,0.14)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--pri);border-color:rgba(99,102,241,0.55)}
  .btn.primary:hover{background:rgba(99,102,241,0.36)}
  .btn.small{padding:8px 10px;font-size:12px;border-radius:999px}
  .btn.good{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35)}
  .btn.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35)}
  .toggle{
    display:flex;align-items:center;gap:10px;
    padding:8px 10px;border-radius:12px;border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
  }
  .toggle label{font-size:12px;color:var(--muted);cursor:pointer}
  .toggle input{accent-color:rgb(99,102,241)}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .qbox{
    background:rgba(255,255,255,0.05);
    border:1px solid var(--line);
    border-radius:16px;padding:14px;
    min-height:120px;
  }
  .qmeta{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  .badge{
    font-size:12px;color:var(--muted);
    border:1px solid var(--line);
    padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.04);
  }
  .question{font-size:22px;font-weight:700;letter-spacing:.2px;margin:0}
  .mini{font-size:12px;color:var(--muted);margin-top:8px}
  .options{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
  .opt{
    text-align:left;
    padding:12px 12px;border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
    color:var(--text);
    cursor:pointer;
    transition:background .12s ease, transform .06s ease;
  }
  .opt:hover{background:rgba(255,255,255,0.08)}
  .opt:active{transform:translateY(1px)}
  .opt.correct{background:var(--good);border-color:rgba(34,197,94,0.55)}
  .opt.wrong{background:var(--bad);border-color:rgba(239,68,68,0.55)}
  .typingRow{display:none;gap:10px;flex-wrap:wrap;margin-top:12px}
  .typingRow input{flex:1 1 260px}
  .reveal{
    margin-top:10px;
    padding:12px;border-radius:14px;border:1px solid var(--line);
    background:rgba(255,255,255,0.04);
    display:none;
  }
  .reveal.show{display:block}
  .rateRow{display:none;gap:10px;flex-wrap:wrap;margin-top:12px}
  .statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .stat{background:rgba(255,255,255,0.05);border:1px solid var(--line);border-radius:16px;padding:12px}
  .stat .k{color:var(--muted);font-size:12px;margin-bottom:6px}
  .stat .v{font-size:18px;font-weight:700}
  .list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:8px}
  .li{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,0.04);cursor:pointer}
  .li .name{font-size:13px}
  .li .count{font-size:12px;color:var(--muted)}
  .kbd{
    border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
    padding:2px 6px;border-radius:8px;
    font-size:12px;color:var(--muted);
  }
  .hints{margin-top:10px;color:rgba(255,255,255,.42);font-size:12px}
</style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div>
      <h1>Word Flip ‚Äì EN‚ÜîSK tr√©ning</h1>
      <div class="sub">Mix (vyv√°≈æen√©): SRS + MC default + prep√≠naƒç P√≠sanie + TTS (auto ƒç√≠tanie po prvom kliknut√≠).</div>
    </div>
    <div class="pillrow">
      <div class="pill" id="pillDataset">Polo≈æky: ‚Ä¶</div>
      <div class="pill" id="pillUnique">Unik√°tne: ‚Ä¶</div>
      <div class="pill" id="pillDue">Na dnes: ‚Ä¶</div>
    </div>
  </div>

  <div class="grid">
    <!-- STUDY -->
    <div class="card">
      <h2>Tr√©ning</h2>

      <div class="row">
        <select id="packSelect" title="Bal√≠k"></select>

        <select id="typeSelect" title="Typ">
          <option value="all">V≈°etko</option>
          <option value="vocab">Len slov√≠ƒçka</option>
          <option value="phrase">Len fr√°zy/vety</option>
        </select>

        <select id="dirSelect" title="Smer">
          <option value="en2sk">EN ‚Üí SK</option>
          <option value="sk2en">SK ‚Üí EN</option>
          <option value="mix">Mix</option>
        </select>

        <select id="modeSelect" title="Re≈æim">
          <option value="mc">V√Ωber (4 mo≈ænosti)</option>
          <option value="typing">P√≠sanie</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="startBtn">≈†tart / Pokraƒçova≈•</button>
        <button class="btn" id="nextBtn">ƒéal≈°ia</button>
        <button class="btn" id="ttsBtn" title="Preƒç√≠ta≈• nahlas (S)">üîä TTS</button>

        <div class="toggle" title="Automaticky ƒç√≠ta≈• ka≈æd√∫ nov√∫ ot√°zku (po prvom kliknut√≠ v appke)">
          <input type="checkbox" id="autoTtsToggle" checked />
          <label for="autoTtsToggle">Auto TTS</label>
        </div>

        <div class="toggle" title="Uƒçi≈• len karty, ktor√© s√∫ na dnes (SRS)">
          <input type="checkbox" id="dueOnlyToggle" checked />
          <label for="dueOnlyToggle">Len na dnes</label>
        </div>

        <div class="toggle" title="Odstr√°ni identick√© duplicity kariet">
          <input type="checkbox" id="dedupToggle" checked />
          <label for="dedupToggle">Dedup</label>
        </div>

        <div class="toggle" title="Automaticky prejs≈• na ƒèal≈°iu po odpovedi">
          <input type="checkbox" id="autoNextToggle" checked />
          <label for="autoNextToggle">Auto next</label>
        </div>
      </div>

      <div class="sep"></div>

      <div class="qbox">
        <div class="qmeta">
          <div class="row">
            <span class="badge" id="badgePack">Pack: ‚Äì</span>
            <span class="badge" id="badgeType">Type: ‚Äì</span>
            <span class="badge" id="badgeBox">Box: ‚Äì</span>
          </div>
          <div class="row">
            <span class="badge" id="badgeProgress">Dnes: 0/20</span>
            <span class="badge" id="badgeAcc">Presnos≈•: 0%</span>
          </div>
        </div>

        <p class="question" id="question">Klikni ‚Äû≈†tart / Pokraƒçova≈•‚Äú</p>
        <div class="mini" id="qMini"></div>

        <div class="reveal" id="revealBox">
          <div class="mini">Spr√°vna odpoveƒè</div>
          <div style="font-size:18px;font-weight:700;margin-top:4px" id="revealAnswer">‚Äî</div>
          <div class="mini" id="revealInfo"></div>
        </div>

        <div class="options" id="options"></div>

        <div class="typingRow" id="typingRow">
          <input type="text" id="typingInput" placeholder="Nap√≠≈° odpoveƒè a Enter‚Ä¶" autocomplete="off" />
          <button class="btn" id="checkTypingBtn">Skontroluj</button>
          <button class="btn" id="showAnswerBtn">Uk√°≈æ odpoveƒè</button>
        </div>

        <div class="rateRow" id="rateRow">
          <button class="btn danger" id="btnAgain">Again</button>
          <button class="btn" id="btnHard">Hard</button>
          <button class="btn good" id="btnGood">Good</button>
          <button class="btn primary" id="btnEasy">Easy</button>
        </div>
      </div>

      <div class="hints">
        Skratky: <span class="kbd">1‚Äì4</span> v√Ωber ‚Ä¢ <span class="kbd">Enter</span> potvrƒè (p√≠sanie) / ƒèal≈°ia ‚Ä¢ <span class="kbd">S</span> TTS ‚Ä¢ Auto ƒç√≠tanie: zapni ‚ÄûAuto TTS‚Äú
      </div>
    </div>

    <!-- DASH -->
    <div class="card">
      <h2>Dashboard</h2>

      <div class="statsGrid">
        <div class="stat">
          <div class="k">Dnes hotovo</div>
          <div class="v" id="statDone">0</div>
          <div class="mini" id="statDoneMini">z cieƒæa 20</div>
        </div>
        <div class="stat">
          <div class="k">Na dnes (due)</div>
          <div class="v" id="statDue">0</div>
          <div class="mini">v aktu√°lnom v√Ωbere</div>
        </div>
        <div class="stat">
          <div class="k">Presnos≈• (rel√°cia)</div>
          <div class="v" id="statAcc">0%</div>
          <div class="mini" id="statAccMini">0/0</div>
        </div>
        <div class="stat">
          <div class="k">Cieƒæ na de≈à</div>
          <div class="v"><span id="statGoal">20</span></div>
          <div class="mini">
            <span style="color:var(--muted)">Nastav:</span>
            <input id="goalInput" type="number" min="5" max="200" step="5" value="20" />
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between">
        <div>
          <div class="sub" style="margin:0;color:var(--muted)">SRS progres sa uklad√° lok√°lne (v prehliadaƒçi).</div>
        </div>
        <div class="row">
          <button class="btn small" id="resetSessionBtn">Reset rel√°cie</button>
          <button class="btn small danger" id="wipeProgressBtn">Zma≈æ progres</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="sub" style="margin:0 0 10px 0;color:var(--muted)">Packy (klik = prepni pack)</div>
      <ul class="list" id="packList"></ul>
    </div>
  </div>
</div>

<script>
/* =========================
   DATA
========================= */
const DATASET_URL = "./wordflip_dataset_en_sk.json";
const DATASET_FALLBACK = [
  {"type":"vocab","pack":"colors","en":"red","sk":"ƒçerven√°"},
  {"type":"vocab","pack":"colors","en":"blue","sk":"modr√°"},
  {"type":"phrase","pack":"phrases","en":"Hello!","sk":"Ahoj!"}
];
let DATASET = [...DATASET_FALLBACK];

/* =========================
   STORAGE
========================= */
const STORAGE_SRS = "wordflip_srs_v2";
const STORAGE_SETTINGS = "wordflip_settings_v2";
const STORAGE_DAILY = "wordflip_daily_v2";

/* SRS intervals (days) */
const BOX_INTERVAL_DAYS = {1:0, 2:1, 3:3, 4:7, 5:14};

/* =========================
   STATE
========================= */
let settings = {
  pack: "all",
  type: "all",
  dir: "en2sk",
  mode: "mc",
  autoTts: true,        // NEW
  dueOnly: true,
  dedup: true,
  autoNext: true,
  goal: 20
};

let session = { answered: 0, correct: 0, doneToday: 0 };
let srsMap = {};

let pool = [];
let current = null;
let currentQA = null;
let revealed = false;

/* =========================
   HELPERS
========================= */
const $ = (id) => document.getElementById(id);
const now = () => Date.now();
const normalize = (s) => String(s ?? "").trim();
const normCompare = (s) => normalize(s).toLowerCase().replace(/\s+/g,' ');
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function safeParse(s, fb){ try{ return JSON.parse(s); } catch { return fb; } }
function packTitle(pack){
  return normalize(pack).replace(/^ff3-/, 'FF3 ‚Äì ').replace(/-/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
}
function itemKey(it){
  return `${normalize(it.type)}|${normalize(it.pack)}|${normalize(it.en)}|${normalize(it.sk)}`;
}

/* =========================
   AUTO TTS (browser policy)
========================= */
let ttsUnlocked = false;

function unlockTtsOnce(){
  ttsUnlocked = true;
  document.removeEventListener("pointerdown", unlockTtsOnce);
  document.removeEventListener("keydown", unlockTtsOnce);
}
document.addEventListener("pointerdown", unlockTtsOnce);
document.addEventListener("keydown", unlockTtsOnce);

function speakIfAuto(){
  const autoOn = $("autoTtsToggle")?.checked;
  if(!autoOn) return;
  if(!ttsUnlocked) return;
  if(!currentQA) return;
  // mal√© oneskorenie: aby UI stihlo vykresli≈• text
  setTimeout(() => ttsSpeak(currentQA.q), 60);
}

/* =========================
   SETTINGS / DAILY
========================= */
function loadSettings(){
  const s = safeParse(localStorage.getItem(STORAGE_SETTINGS) || "null", null);
  if(s && typeof s === "object") settings = {...settings, ...s};
}
function saveSettings(){
  localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
}
function loadDaily(){
  const daily = safeParse(localStorage.getItem(STORAGE_DAILY) || "{}", {});
  session.doneToday = Number(daily[todayKey()] || 0);
}
function incDaily(n=1){
  const daily = safeParse(localStorage.getItem(STORAGE_DAILY) || "{}", {});
  const k = todayKey();
  daily[k] = Number(daily[k] || 0) + n;
  localStorage.setItem(STORAGE_DAILY, JSON.stringify(daily));
  session.doneToday = daily[k];
}

/* =========================
   SRS
========================= */
function loadSrs(){
  srsMap = safeParse(localStorage.getItem(STORAGE_SRS) || "{}", {});
  if(!srsMap || typeof srsMap !== "object") srsMap = {};
}
function saveSrs(){
  localStorage.setItem(STORAGE_SRS, JSON.stringify(srsMap));
}
function ensureSrs(it){
  const k = itemKey(it);
  if(!srsMap[k]) srsMap[k] = { box: 1, dueTs: 0, lastTs: 0, streak: 0 };
  return srsMap[k];
}
function isDue(it){
  const rec = ensureSrs(it);
  return Number(rec.dueTs || 0) <= now();
}
function schedule(it, rating){
  const rec = ensureSrs(it);
  rec.lastTs = now();

  if(rating === "again"){ rec.box = 1; rec.streak = 0; }
  else if(rating === "hard"){ rec.streak = Math.max(0, rec.streak || 0); }
  else if(rating === "good"){ rec.box = Math.min(5, rec.box + 1); rec.streak = (rec.streak||0) + 1; }
  else if(rating === "easy"){ rec.box = Math.min(5, rec.box + 2); rec.streak = (rec.streak||0) + 1; }

  const days = BOX_INTERVAL_DAYS[rec.box] ?? 1;
  rec.dueTs = now() + days*24*60*60*1000;

  saveSrs();
}

/* =========================
   DATASET UTILS
========================= */
function cleanDataset(raw){
  return raw.map(x => ({
    type: normalize(x.type),
    pack: normalize(x.pack),
    en: normalize(x.en),
    sk: normalize(x.sk),
  })).filter(x => (x.type === "vocab" || x.type === "phrase") && x.pack && x.en && x.sk);
}
function dedupDataset(list){
  const seen = new Set();
  const out = [];
  for(const it of list){
    const k = itemKey(it);
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(it);
  }
  return out;
}
function buildPackIndex(list){
  const map = new Map();
  for(const it of list){
    if(!map.has(it.pack)) map.set(it.pack, {pack: it.pack, title: packTitle(it.pack), count:0});
    map.get(it.pack).count += 1;
  }
  return Array.from(map.values()).sort((a,b)=>a.title.localeCompare(b.title,'sk'));
}

/* =========================
   QA + DISTRACTORS
========================= */
function getQA(it, dir){
  let used = dir;
  if(dir === "mix") used = Math.random() < 0.5 ? "en2sk" : "sk2en";
  const q = (used === "en2sk") ? it.en : it.sk;
  const a = (used === "en2sk") ? it.sk : it.en;
  return { q, a, dirUsed: used };
}

function pickDistractors(correctAnswer, datasetAll, it, dirUsed){
  const need = 4;
  const used = new Set([correctAnswer]);
  const out = [correctAnswer];

  const sameType = datasetAll.filter(x => x.type === it.type);
  const samePackSameType = sameType.filter(x => x.pack === it.pack);

  function maybePush(x){
    const cand = (dirUsed === "en2sk") ? x.sk : x.en;
    const v = normalize(cand);
    if(!v || used.has(v)) return;
    used.add(v);
    out.push(v);
  }

  while(out.length < need && samePackSameType.length){
    const r = samePackSameType[Math.floor(Math.random()*samePackSameType.length)];
    maybePush(r);
  }
  while(out.length < need && sameType.length){
    const r = sameType[Math.floor(Math.random()*sameType.length)];
    maybePush(r);
  }
  while(out.length < need){
    const r = datasetAll[Math.floor(Math.random()*datasetAll.length)];
    maybePush(r);
    if(datasetAll.length === 1) break;
  }

  out.sort(()=>Math.random()-0.5);
  return out;
}

/* =========================
   UI BUILD
========================= */
function applySettingsToControls(){
  $("typeSelect").value = settings.type;
  $("dirSelect").value = settings.dir;
  $("modeSelect").value = settings.mode;
  $("autoTtsToggle").checked = settings.autoTts !== false;
  $("dueOnlyToggle").checked = !!settings.dueOnly;
  $("dedupToggle").checked = !!settings.dedup;
  $("autoNextToggle").checked = !!settings.autoNext;
  $("goalInput").value = settings.goal;
}
function readControlsToSettings(){
  settings.pack = $("packSelect").value;
  settings.type = $("typeSelect").value;
  settings.dir = $("dirSelect").value;
  settings.mode = $("modeSelect").value;
  settings.autoTts = $("autoTtsToggle").checked;
  settings.dueOnly = $("dueOnlyToggle").checked;
  settings.dedup = $("dedupToggle").checked;
  settings.autoNext = $("autoNextToggle").checked;
  settings.goal = Number($("goalInput").value || 20);
  saveSettings();
}
function buildPackSelect(){
  const sel = $("packSelect");
  sel.innerHTML = "";

  const base = settings.dedup ? dedupDataset(DATASET) : DATASET;
  const packs = buildPackIndex(base);

  const oAll = document.createElement("option");
  oAll.value = "all";
  oAll.textContent = "V≈°etko";
  sel.appendChild(oAll);

  for(const p of packs){
    const o = document.createElement("option");
    o.value = p.pack;
    o.textContent = `${p.title} (${p.count})`;
    sel.appendChild(o);
  }

  const exists = settings.pack === "all" || base.some(x => x.pack === settings.pack);
  sel.value = exists ? settings.pack : "all";
}
function updatePills(){
  $("pillDataset").textContent = `Polo≈æky: ${DATASET.length}`;
  const unique = dedupDataset(DATASET).length;
  $("pillUnique").textContent = `Unik√°tne: ${unique}`;

  const list = getFilteredList();
  $("pillDue").textContent = `Na dnes: ${countDue(list)}`;
}
function updatePackList(){
  const ul = $("packList");
  ul.innerHTML = "";

  const base = settings.dedup ? dedupDataset(DATASET) : DATASET;
  const packs = buildPackIndex(base);
  const typeFilter = settings.type;

  for(const p of packs){
    let items = base.filter(x => x.pack === p.pack);
    if(typeFilter !== "all") items = items.filter(x => x.type === typeFilter);
    const due = countDue(items);

    const li = document.createElement("li");
    li.className = "li";
    li.innerHTML = `<div class="name">${p.title}</div><div class="count">spolu ${items.length} ‚Ä¢ dnes ${due}</div>`;
    li.addEventListener("click", () => {
      $("packSelect").value = p.pack;
      readControlsToSettings();
      buildPool();
      pickNext();
    });
    ul.appendChild(li);
  }
}

/* =========================
   FILTER + POOL
========================= */
function getFilteredList(){
  const base = settings.dedup ? dedupDataset(DATASET) : DATASET;

  let list = base;
  if(settings.type !== "all") list = list.filter(x => x.type === settings.type);
  if(settings.pack !== "all") list = list.filter(x => x.pack === settings.pack);

  for(const it of base) ensureSrs(it);
  saveSrs();

  return list;
}
function countDue(list){
  let n = 0;
  for(const it of list) if(isDue(it)) n++;
  return n;
}
function buildPool(){
  const list = getFilteredList();
  pool = settings.dueOnly ? list.filter(isDue) : list.slice();
  updatePills();
  updatePackList();
  updateDashboard();
}

/* =========================
   STUDY FLOW
========================= */
function showReveal(ans, info){
  $("revealAnswer").textContent = ans;
  $("revealInfo").textContent = info || "";
  $("revealBox").classList.add("show");
  $("rateRow").style.display = "flex";
  revealed = true;
}
function hideReveal(){
  $("revealBox").classList.remove("show");
  $("rateRow").style.display = "none";
  revealed = false;
}
function setModeUI(){
  const mode = settings.mode;
  $("options").style.display = (mode === "mc") ? "grid" : "none";
  $("typingRow").style.display = (mode === "typing") ? "flex" : "none";
}
function setBadges(it){
  $("badgePack").textContent = `Pack: ${packTitle(it.pack)}`;
  $("badgeType").textContent = `Type: ${it.type}`;
  const rec = ensureSrs(it);
  $("badgeBox").textContent = `Box: ${rec.box}`;
}
function updateDashboard(){
  $("statGoal").textContent = settings.goal;

  $("statDone").textContent = session.doneToday;
  $("statDoneMini").textContent = `z cieƒæa ${settings.goal}`;

  const list = getFilteredList();
  $("statDue").textContent = countDue(list);

  const acc = session.answered ? Math.round((session.correct/session.answered)*100) : 0;
  $("statAcc").textContent = `${acc}%`;
  $("statAccMini").textContent = `${session.correct}/${session.answered || 0}`;

  $("badgeProgress").textContent = `Dnes: ${Math.min(session.doneToday, settings.goal)}/${settings.goal}`;
  $("badgeAcc").textContent = `Presnos≈•: ${acc}%`;
}

function renderOptions(opts, correct){
  const box = $("options");
  box.innerHTML = "";
  opts.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.innerHTML = `<span style="color:var(--muted);font-size:12px;margin-right:8px">${idx+1}</span>${opt}`;
    btn.addEventListener("click", () => checkMC(btn, opt, correct));
    box.appendChild(btn);
  });
}
function lockOptions(){
  Array.from(document.querySelectorAll(".opt")).forEach(b => b.disabled = true);
}
function pickNext(){
  readControlsToSettings();
  buildPool();
  setModeUI();
  hideReveal();

  if(pool.length === 0){
    $("question").textContent = "V tomto v√Ωbere nie je niƒç ‚Äûna dnes‚Äú. Vypni ‚ÄûLen na dnes‚Äú alebo zme≈à pack/typ.";
    $("qMini").textContent = "";
    $("options").innerHTML = "";
    $("typingInput").value = "";
    return;
  }

  current = pool[Math.floor(Math.random()*pool.length)];
  currentQA = getQA(current, settings.dir);

  $("question").textContent = currentQA.q;
  $("qMini").textContent = `Smer: ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${packTitle(current.pack)}`;

  setBadges(current);

  const baseAll = settings.dedup ? dedupDataset(DATASET) : DATASET;

  if(settings.mode === "mc"){
    const opts = pickDistractors(currentQA.a, baseAll, current, currentQA.dirUsed);
    renderOptions(opts, currentQA.a);
  } else {
    $("options").innerHTML = "";
    $("typingInput").value = "";
    $("typingInput").focus();
  }

  // AUTO TTS on every new question (after first interaction)
  speakIfAuto();
}

function checkMC(btn, choice, correct){
  lockOptions();
  session.answered += 1;

  if(choice === correct){
    btn.classList.add("correct");
    session.correct += 1;
    incDaily(1);
    schedule(current, "good");
    showReveal(correct, `Spr√°vne ‚Ä¢ ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${current.type}`);
  } else {
    btn.classList.add("wrong");
    Array.from(document.querySelectorAll(".opt")).forEach(b => {
      const txt = b.textContent.replace(/^\d\s*/,'').trim();
      if(txt === correct) b.classList.add("correct");
    });
    schedule(current, "again");
    showReveal(correct, `Nespr√°vne ‚Ä¢ ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${current.type}`);
  }

  updateDashboard();

  if(settings.autoNext){
    setTimeout(() => pickNext(), 850);
  }
}

/* tolerant typing */
function levenshtein(a, b){
  a = normCompare(a); b = normCompare(b);
  const m = a.length, n = b.length;
  if(m === 0) return n;
  if(n === 0) return m;
  const dp = Array.from({length:m+1}, () => new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + cost
      );
    }
  }
  return dp[m][n];
}

function checkTyping(){
  if(!current) return;
  const user = $("typingInput").value;
  const target = currentQA.a;

  session.answered += 1;

  const ua = normCompare(user);
  const ta = normCompare(target);
  const dist = levenshtein(ua, ta);

  const ok = (ua === ta) || (dist <= Math.max(1, Math.floor(ta.length * 0.12)));

  if(ok){
    session.correct += 1;
    incDaily(1);
    schedule(current, "good");
    showReveal(target, `OK ‚Ä¢ vzdialenos≈• ${dist} ‚Ä¢ ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${current.type}`);
  } else {
    schedule(current, "again");
    showReveal(target, `Nesed√≠ ‚Ä¢ vzdialenos≈• ${dist} ‚Ä¢ ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${current.type}`);
  }

  updateDashboard();

  if(settings.autoNext){
    setTimeout(() => pickNext(), 950);
  }
}

function rate(r){
  if(!current) return;
  schedule(current, r);
  if(r === "good" || r === "easy") incDaily(1);
  updateDashboard();
  if(settings.autoNext) setTimeout(() => pickNext(), 450);
}

/* =========================
   TTS
========================= */
function ttsSpeak(text){
  const t = normalize(text);
  if(!t) return;
  if(!("speechSynthesis" in window)){ alert("TTS nie je podporovan√© v tomto prehliadaƒçi."); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(t);
  const hasSK = /[√°√§ƒçƒè√©√≠ƒ∫ƒæ≈à√≥√¥≈ï≈°≈•√∫√Ω≈æ]/i.test(t);
  u.lang = hasSK ? "sk-SK" : "en-US";
  u.rate = 0.95;
  window.speechSynthesis.speak(u);
}

/* =========================
   ACTIONS
========================= */
function resetSession(){
  session.answered = 0;
  session.correct = 0;
  hideReveal();
  updateDashboard();
}
function wipeProgress(){
  localStorage.removeItem(STORAGE_SRS);
  loadSrs();
  buildPool();
  pickNext();
}

/* =========================
   LOAD DATASET
========================= */
async function loadDataset(){
  try{
    const res = await fetch(DATASET_URL, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.json();
    if(!Array.isArray(raw)) throw new Error("JSON nie je pole");
    DATASET = cleanDataset(raw);
    if(DATASET.length === 0) throw new Error("Dataset pr√°zdny po ƒçisten√≠");
  } catch(e){
    console.warn("Dataset load failed -> fallback", e);
    DATASET = cleanDataset(DATASET_FALLBACK);
  }
}

/* =========================
   INIT / EVENTS
========================= */
function wire(){
  $("startBtn").addEventListener("click", () => {
    // click = interaction => unlock; then pick and auto-speak
    ttsUnlocked = true;
    pickNext();
  });

  $("nextBtn").addEventListener("click", () => {
    ttsUnlocked = true;
    pickNext();
  });

  $("ttsBtn").addEventListener("click", () => {
    ttsUnlocked = true;
    if(currentQA) ttsSpeak(currentQA.q);
  });

  $("autoTtsToggle").addEventListener("change", () => { readControlsToSettings(); });
  $("typeSelect").addEventListener("change", () => { readControlsToSettings(); buildPool(); });
  $("dirSelect").addEventListener("change", () => { readControlsToSettings(); });
  $("modeSelect").addEventListener("change", () => { readControlsToSettings(); setModeUI(); hideReveal(); });
  $("packSelect").addEventListener("change", () => { readControlsToSettings(); buildPool(); });

  $("dueOnlyToggle").addEventListener("change", () => { readControlsToSettings(); buildPool(); });
  $("dedupToggle").addEventListener("change", () => { readControlsToSettings(); buildPackSelect(); buildPool(); });
  $("autoNextToggle").addEventListener("change", () => { readControlsToSettings(); });

  $("goalInput").addEventListener("change", () => { readControlsToSettings(); updateDashboard(); });

  $("resetSessionBtn").addEventListener("click", () => resetSession());
  $("wipeProgressBtn").addEventListener("click", () => {
    if(confirm("Zmaza≈• SRS progres (boxy/due) pre v≈°etky karty?")) wipeProgress();
  });

  $("checkTypingBtn").addEventListener("click", () => checkTyping());
  $("showAnswerBtn").addEventListener("click", () => {
    if(!current) return;
    showReveal(currentQA.a, `Uk√°zan√© ‚Ä¢ teraz ohodno≈• Again/Hard/Good/Easy`);
  });

  $("typingInput").addEventListener("keydown", (e) => {
    if(e.key === "Enter") checkTyping();
  });

  $("btnAgain").addEventListener("click", () => rate("again"));
  $("btnHard").addEventListener("click", () => rate("hard"));
  $("btnGood").addEventListener("click", () => rate("good"));
  $("btnEasy").addEventListener("click", () => rate("easy"));

  document.addEventListener("keydown", (e) => {
    if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;

    if(e.key === "s" || e.key === "S"){
      ttsUnlocked = true;
      if(currentQA) ttsSpeak(currentQA.q);
    }

    if(settings.mode === "mc" && ["1","2","3","4"].includes(e.key)){
      const idx = Number(e.key) - 1;
      const btns = Array.from(document.querySelectorAll(".opt"));
      if(btns[idx] && !btns[idx].disabled) btns[idx].click();
    }

    if(e.key === "Enter"){
      if(settings.mode === "typing" && !revealed){
        $("typingInput").focus();
      } else {
        ttsUnlocked = true;
        pickNext();
      }
    }
  });
}

(async function init(){
  loadSettings();
  await loadDataset();
  loadSrs();
  loadDaily();

  applySettingsToControls();
  buildPackSelect();
  readControlsToSettings();

  buildPool();
  setModeUI();
  updateDashboard();
  wire();
})();
</script>
</body>
</html>

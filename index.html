<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Word Flip – EN↔SK tréning</title>
<style>
  body{font-family:system-ui;margin:0;background:#f7f8ff;color:#1f2937}
  .wrap{max-width:1000px;margin:auto;padding:20px}
  .card{background:#fff;padding:16px;border-radius:14px;margin-bottom:15px}
  button{padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
  .opt{display:block;width:100%;margin:6px 0;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff;text-align:left}
  .opt.correct{background:#d1fae5}
  .opt.wrong{background:#fee2e2}
  .btnSmall{font-size:12px;padding:6px 10px;margin-left:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff}
  .muted{color:#6b7280;font-size:12px}
  .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
</style>
</head>
<body>
<div class="wrap">
  <h2>Word Flip – EN↔SK tréning</h2>

  <div class="card">
    <div class="bar">
      <div class="row">
        <select id="packSelect"></select>

        <select id="modeSelect" title="Smer prekladu">
          <option value="en2sk">EN → SK</option>
          <option value="sk2en">SK → EN</option>
          <option value="mix">Mix</option>
        </select>

        <button id="startBtn">Spustiť hru</button>
        <button id="clearMistakesBtn" class="btnSmall">Vymaž chyby</button>
      </div>

      <div>
        <div id="scoreBox">Skóre: 0</div>
        <div id="statusBox" class="muted"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="question" style="font-size:18px;font-weight:600;margin-bottom:10px"></div>
    <div id="options"></div>
  </div>
</div>

<script>
/**
 * DATASET = zdroj pravdy
 * - primárne načítame z externého JSON súboru
 * - ak zlyhá, použijeme FALLBACK (vstavané minimum), aby appka fungovala vždy
 *
 * DÔLEŽITÉ:
 * - JSON musí byť pole objektov: [{type, pack, en, sk}, ...]
 * - Súbor ulož vedľa index.html (napr. /wordflip_dataset_en_sk.json)
 */
const DATASET_URL = "./wordflip_dataset_en_sk.json";

/* ====== FALLBACK dataset (minimálny) ======
   Ak chceš, môžeš sem nechať tvoj pôvodný veľký dataset.
   Ja dávam len krátky, aby bol súbor čitateľný; po deployi
   sa načíta JSON a fallback sa nebude používať.
*/
const DATASET_FALLBACK = [
  {"type":"vocab","pack":"colors","en":"red","sk":"červená"},
  {"type":"vocab","pack":"colors","en":"blue","sk":"modrá"},
  {"type":"vocab","pack":"numbers","en":"one","sk":"jeden"},
  {"type":"vocab","pack":"numbers","en":"two","sk":"dva"},
  {"type":"phrase","pack":"phrases","en":"Hello!","sk":"Ahoj!"},
  {"type":"phrase","pack":"phrases","en":"How are you?","sk":"Ako sa máš?"}
];

// POZOR: už to nie je const, lebo ho prepíšeme po načítaní z JSON
let DATASET = [...DATASET_FALLBACK];

/* ====== Nastavenia + storage ====== */
const STORAGE_MISTAKES = 'wordflip_mistakes_v3';
const OPTION_COUNT = 4;

let pool = [];
let score = 0;
let current = null;
let currentMode = 'en2sk'; // en2sk | sk2en | mix

/* ====== Pomocné funkcie ====== */
function normalize(s){
  return String(s ?? '').trim();
}

function packTitle(pack){
  return pack
    .replace(/^ff3-/, 'FF3 – ')
    .replace(/-/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

function buildIndex(dataset){
  const map = new Map();
  for(const item of dataset){
    const pack = normalize(item.pack) || 'unknown';
    if(!map.has(pack)){
      map.set(pack, { pack, title: packTitle(pack), itemCount: 0, typeCounts: { vocab: 0, phrase: 0 } });
    }
    const rec = map.get(pack);
    rec.itemCount += 1;
    if(item.type === 'vocab') rec.typeCounts.vocab += 1;
    else if(item.type === 'phrase') rec.typeCounts.phrase += 1;
  }
  return Array.from(map.values()).sort((a,b)=>a.title.localeCompare(b.title,'sk'));
}

function validateDataset(dataset){
  const issues = [];

  dataset.forEach((it, i) => {
    const type = normalize(it.type);
    const pack = normalize(it.pack);
    const en = normalize(it.en);
    const sk = normalize(it.sk);

    if(!type || !pack || !en || !sk){
      issues.push(`Riadok ${i+1}: chýba type/pack/en/sk`);
    }
    if(type !== 'vocab' && type !== 'phrase'){
      issues.push(`Riadok ${i+1}: neznámy type "${type}"`);
    }
  });

  // duplicitné EN v rámci packu+type (často je to chyba v dátach)
  const seen = new Map();
  dataset.forEach((it, i) => {
    const key = `${normalize(it.type)}|${normalize(it.pack)}|${normalize(it.en).toLowerCase()}`;
    if(!normalize(it.en)) return;
    if(seen.has(key)){
      issues.push(`Riadok ${i+1}: duplicitné EN v packu (kľúč: ${key})`);
    } else seen.set(key, i);
  });

  return issues;
}

function saveMistake(item, mode){
  const saved = JSON.parse(localStorage.getItem(STORAGE_MISTAKES) || "[]");
  const key = `${normalize(item.pack)}|${normalize(item.type)}|${normalize(item.en)}|${normalize(item.sk)}|${mode}`;
  if(!saved.find(x => x.key === key)){
    saved.push({ key, item, mode, ts: Date.now() });
    localStorage.setItem(STORAGE_MISTAKES, JSON.stringify(saved));
  }
}

function loadMistakes(){
  return JSON.parse(localStorage.getItem(STORAGE_MISTAKES) || "[]");
}

function clearMistakes(){
  localStorage.removeItem(STORAGE_MISTAKES);
}

/* ====== Dataset loader ====== */
async function loadDataset(){
  setStatus("Načítavam dataset…");

  try{
    const res = await fetch(DATASET_URL, { cache: "no-store" });
    if(!res.ok){
      throw new Error(`HTTP ${res.status} ${res.statusText}`);
    }
    const data = await res.json();
    if(!Array.isArray(data)){
      throw new Error("JSON nie je pole (array). Očakávam: [{type,pack,en,sk}, ...]");
    }

    // jemné čistenie (trimy)
    const cleaned = data.map(x => ({
      type: normalize(x.type),
      pack: normalize(x.pack),
      en: normalize(x.en),
      sk: normalize(x.sk),
    })).filter(x => x.type && x.pack && x.en && x.sk);

    if(cleaned.length === 0){
      throw new Error("Dataset je prázdny po čistení (skontroluj type/pack/en/sk).");
    }

    DATASET = cleaned;

    const issues = validateDataset(DATASET);
    if(issues.length){
      console.warn("Dataset issues:", issues);
      setStatus(`Dataset načítaný (${DATASET.length}). Upozornenia: ${issues.length} (pozri konzolu).`);
    } else {
      setStatus(`Dataset načítaný OK (${DATASET.length}).`);
    }
  } catch(err){
    console.warn("Dataset load failed, using fallback:", err);
    DATASET = [...DATASET_FALLBACK];
    setStatus(`Nepodarilo sa načítať JSON (${DATASET_URL}). Bežím na fallback datasete (${DATASET.length}).`);
  }
}

/* ====== Generovanie otázky a možností ====== */
function getQA(item, mode){
  if(mode === 'mix'){
    mode = Math.random() < 0.5 ? 'en2sk' : 'sk2en';
  }
  if(mode === 'en2sk'){
    return { q: item.en, a: item.sk, mode };
  }
  return { q: item.sk, a: item.en, mode };
}

function pickDistractors(correctAnswer, items, mode, pack){
  const used = new Set([correctAnswer]);
  const options = [correctAnswer];

  const samePack = items.filter(x => normalize(x.pack) === pack);
  while(options.length < OPTION_COUNT && samePack.length > 0){
    const r = samePack[Math.floor(Math.random() * samePack.length)];
    const cand = (mode === 'en2sk') ? r.sk : r.en;
    const v = normalize(cand);
    if(v && !used.has(v)){
      used.add(v);
      options.push(v);
    }
  }

  while(options.length < OPTION_COUNT){
    const r = items[Math.floor(Math.random() * items.length)];
    const cand = (mode === 'en2sk') ? r.sk : r.en;
    const v = normalize(cand);
    if(v && !used.has(v)){
      used.add(v);
      options.push(v);
    }
  }

  options.sort(()=>Math.random()-0.5);
  return options;
}

function renderOptions(options, correct){
  const box = document.getElementById("options");
  box.innerHTML = "";

  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.textContent = opt;
    btn.addEventListener("click", () => checkAnswer(btn, opt, correct));
    box.appendChild(btn);
  });
}

/* ====== Hra ====== */
function buildPackSelect(){
  const sel = document.getElementById("packSelect");
  sel.innerHTML = "";

  const index = buildIndex(DATASET);

  const base = [
    { value: "all", label: "Všetko" },
    { value: "mistakes", label: "Tréning chýb" }
  ];

  base.forEach(x => {
    const o = document.createElement("option");
    o.value = x.value;
    o.textContent = x.label;
    sel.appendChild(o);
  });

  index.forEach(p => {
    const o = document.createElement("option");
    o.value = p.pack;
    o.textContent = `${p.title} (${p.itemCount})`;
    sel.appendChild(o);
  });
}

function setStatus(msg){
  document.getElementById("statusBox").textContent = msg || "";
}

function startGame(){
  score = 0;
  document.getElementById("scoreBox").innerText = "Skóre: 0";

  const pack = document.getElementById("packSelect").value;
  currentMode = document.getElementById("modeSelect").value;

  if(pack === "mistakes"){
    const mistakes = loadMistakes();
    pool = mistakes.map(m => m.item);
    setStatus(`Chyby: ${pool.length}`);
  } else if(pack === "all"){
    pool = [...DATASET];
    setStatus(`Položky: ${pool.length}`);
  } else {
    pool = DATASET.filter(x => normalize(x.pack) === pack);
    setStatus(`Pack "${packTitle(pack)}": ${pool.length}`);
  }

  nextQuestion();
}

function nextQuestion(){
  if(pool.length === 0){
    alert("Nie sú dostupné žiadne položky v tomto výbere.");
    return;
  }

  current = pool[Math.floor(Math.random() * pool.length)];

  const qa = getQA(current, currentMode);
  const qText = normalize(qa.q);
  const aText = normalize(qa.a);

  document.getElementById("question").innerText = qText;

  const options = pickDistractors(aText, DATASET, qa.mode, normalize(current.pack));
  renderOptions(options, aText);
}

function checkAnswer(btn, choice, correct){
  const buttons = Array.from(document.querySelectorAll(".opt"));
  buttons.forEach(b => b.disabled = true);

  if(choice === correct){
    btn.classList.add("correct");
    score++;
  } else {
    btn.classList.add("wrong");
    saveMistake(current, currentMode);
    buttons.forEach(b => {
      if(b.textContent === correct) b.classList.add("correct");
    });
  }

  document.getElementById("scoreBox").innerText = "Skóre: " + score;
  setTimeout(nextQuestion, 900);
}

/* ====== Init ====== */
(async function init(){
  await loadDataset();
  buildPackSelect();

  document.getElementById("startBtn").addEventListener("click", startGame);
  document.getElementById("clearMistakesBtn").addEventListener("click", () => {
    clearMistakes();
    alert("Chyby vymazané");
  });
})();
</script>
</body>
</html>

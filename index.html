<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Word Flip ‚Äì EN‚ÜîSK tr√©ning</title>
<style>
  :root{
    --bg: #0b1020;
    --card: rgba(255,255,255,0.08);
    --card2: rgba(255,255,255,0.06);
    --text: rgba(255,255,255,0.92);
    --muted: rgba(255,255,255,0.60);
    --muted2: rgba(255,255,255,0.42);
    --line: rgba(255,255,255,0.12);
    --good: rgba(34,197,94,0.18);
    --bad: rgba(239,68,68,0.18);
    --focus: rgba(99,102,241,0.55);
    --shadow: 0 18px 45px rgba(0,0,0,0.30);
    --radius: 18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:
      radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,0.35), transparent 60%),
      radial-gradient(1000px 600px at 85% 20%, rgba(16,185,129,0.22), transparent 60%),
      radial-gradient(900px 600px at 35% 95%, rgba(244,63,94,0.20), transparent 60%),
      var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    line-height:1.35;
  }
  a{color:inherit}
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .topbar{
    display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
    margin-bottom:14px;
  }
  .title h1{margin:0;font-size:28px;letter-spacing:0.2px}
  .title .sub{margin-top:6px;color:var(--muted);font-size:13px}
  .pillrow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .pill{
    padding:8px 10px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
    color:var(--muted);
    font-size:12px;
  }
  .grid{
    display:grid;grid-template-columns: 1.1fr 0.9fr;gap:14px;
  }
  @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:14px;
  }
  .card h2{margin:0 0 10px 0;font-size:14px;color:var(--muted);font-weight:600;letter-spacing:0.4px;text-transform:uppercase}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:0 0 auto}
  select, input[type="text"], input[type="number"]{
    background:rgba(255,255,255,0.06);
    border:1px solid var(--line);
    color:var(--text);
    border-radius:12px;
    padding:10px 12px;
    outline:none;
  }
  select:focus, input:focus{box-shadow:0 0 0 4px rgba(99,102,241,0.18);border-color:rgba(99,102,241,0.6)}
  input[type="number"]{width:110px}
  .btn{
    background:rgba(255,255,255,0.10);
    border:1px solid var(--line);
    color:var(--text);
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
    transition:transform .06s ease, background .15s ease, border .15s ease;
    user-select:none;
  }
  .btn:hover{background:rgba(255,255,255,0.14)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{
    background:rgba(99,102,241,0.28);
    border-color:rgba(99,102,241,0.55);
  }
  .btn.primary:hover{background:rgba(99,102,241,0.34)}
  .btn.danger{background:rgba(239,68,68,0.18);border-color:rgba(239,68,68,0.35)}
  .btn.good{background:rgba(34,197,94,0.18);border-color:rgba(34,197,94,0.35)}
  .btn.small{padding:8px 10px;font-size:12px;border-radius:999px}
  .btn.wide{min-width:150px}
  .toggle{
    display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
  }
  .toggle label{font-size:12px;color:var(--muted);cursor:pointer}
  .toggle input{accent-color: rgb(99,102,241)}
  .muted{color:var(--muted);font-size:12px}
  .muted2{color:var(--muted2);font-size:12px}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .qbox{
    background:rgba(255,255,255,0.05);
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px;
    min-height:110px;
  }
  .qmeta{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  .qmeta .left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{
    font-size:12px;color:var(--muted);
    border:1px solid var(--line);
    padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.04);
  }
  .question{
    font-size:22px;font-weight:700;letter-spacing:0.2px;
    margin:0;
  }
  .answerReveal{
    margin-top:10px;
    padding:12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.04);
    display:none;
  }
  .answerReveal.show{display:block}
  .options{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
  .opt{
    text-align:left;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
    color:var(--text);
    cursor:pointer;
    transition:background .12s ease, transform .06s ease;
  }
  .opt:hover{background:rgba(255,255,255,0.08)}
  .opt:active{transform:translateY(1px)}
  .opt.correct{background:var(--good);border-color:rgba(34,197,94,0.55)}
  .opt.wrong{background:var(--bad);border-color:rgba(239,68,68,0.55)}
  .typingRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .typingRow input{flex:1 1 260px}
  .srRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .stat{
    background:rgba(255,255,255,0.05);
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
  }
  .stat .k{color:var(--muted);font-size:12px;margin-bottom:6px}
  .stat .v{font-size:18px;font-weight:700}
  .mini{font-size:12px;color:var(--muted);margin-top:6px}
  .list{
    margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:8px;
  }
  .li{
    display:flex;justify-content:space-between;gap:10px;align-items:center;
    padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,0.04);
  }
  .li .name{font-size:13px}
  .li .count{font-size:12px;color:var(--muted)}
  .footerHints{margin-top:10px;color:var(--muted2);font-size:12px}
  .kbd{
    border:1px solid var(--line);
    background:rgba(255,255,255,0.05);
    padding:2px 6px;border-radius:8px;
    font-size:12px;color:var(--muted);
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="title">
      <h1>Word Flip ‚Äì EN‚ÜîSK tr√©ning</h1>
      <div class="sub">Efekt√≠vnej≈°ie uƒçenie: opakovanie ‚Äúna dnes‚Äù, p√≠sanie, kartiƒçky, ≈°tatistiky, TTS.</div>
    </div>
    <div class="pillrow">
      <div class="pill" id="pillDataset">Dataset: ‚Ä¶</div>
      <div class="pill" id="pillUnique">Unik√°tne: ‚Ä¶</div>
      <div class="pill" id="pillDue">Na dnes: ‚Ä¶</div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: STUDY -->
    <div class="card">
      <h2>Tr√©ning</h2>

      <div class="row">
        <select id="packSelect" title="Bal√≠k"></select>

        <select id="typeSelect" title="Typ">
          <option value="all">V≈°etko (vocab + phrase)</option>
          <option value="vocab">Len slov√≠ƒçka</option>
          <option value="phrase">Len fr√°zy/vety</option>
        </select>

        <select id="dirSelect" title="Smer">
          <option value="en2sk">EN ‚Üí SK</option>
          <option value="sk2en">SK ‚Üí EN</option>
          <option value="mix">Mix</option>
        </select>

        <select id="studyModeSelect" title="Re≈æim uƒçenia">
          <option value="mc">V√Ωber (4 mo≈ænosti)</option>
          <option value="typing">P√≠sanie</option>
          <option value="flip">Kartiƒçka (flip)</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary wide" id="startBtn">≈†tart / Pokraƒçova≈•</button>
        <button class="btn" id="nextBtn">ƒéal≈°ia</button>
        <button class="btn" id="ttsBtn" title="Preƒç√≠ta≈• nahlas (TTS)">üîä TTS</button>

        <div class="toggle" title="Odstr√°ni duplicity (opakovanie rovnak√Ωch kariet)">
          <input type="checkbox" id="dedupToggle" checked />
          <label for="dedupToggle">Dedup</label>
        </div>

        <div class="toggle" title="Uƒçi≈• len to, ƒço je ‚Äúna dnes‚Äù podƒæa SRS">
          <input type="checkbox" id="dueOnlyToggle" checked />
          <label for="dueOnlyToggle">Len ‚Äúna dnes‚Äù</label>
        </div>

        <div class="toggle" title="Automaticky pokraƒçova≈• po odpovedi">
          <input type="checkbox" id="autoNextToggle" checked />
          <label for="autoNextToggle">Auto next</label>
        </div>
      </div>

      <div class="sep"></div>

      <div class="qbox">
        <div class="qmeta">
          <div class="left">
            <span class="badge" id="badgePack">Pack: ‚Äì</span>
            <span class="badge" id="badgeType">Type: ‚Äì</span>
            <span class="badge" id="badgeBox">Box: ‚Äì</span>
          </div>
          <div class="left">
            <span class="badge" id="badgeProgress">Dnes: 0/0</span>
            <span class="badge" id="badgeScore">Sk√≥re: 0</span>
          </div>
        </div>

        <p class="question" id="question">Klikni ‚Äû≈†tart / Pokraƒçova≈•‚Äú</p>

        <div class="answerReveal" id="revealBox">
          <div class="muted">Spr√°vna odpoveƒè</div>
          <div style="font-size:18px;font-weight:700;margin-top:4px" id="revealAnswer">‚Äî</div>
          <div class="mini" id="revealMini">‚Äî</div>
        </div>

        <!-- Multiple choice -->
        <div class="options" id="options"></div>

        <!-- Typing -->
        <div class="typingRow" id="typingRow" style="display:none">
          <input type="text" id="typingInput" placeholder="Nap√≠≈° odpoveƒè a Enter‚Ä¶" autocomplete="off" />
          <button class="btn" id="checkTypingBtn">Skontroluj</button>
          <button class="btn" id="showAnswerBtn">Uk√°≈æ odpoveƒè</button>
        </div>

        <!-- SRS buttons (after reveal / in flip / typing) -->
        <div class="srRow" id="srRow" style="display:none">
          <button class="btn danger" id="btnAgain">Again</button>
          <button class="btn" id="btnHard">Hard</button>
          <button class="btn good" id="btnGood">Good</button>
          <button class="btn primary" id="btnEasy">Easy</button>
        </div>
      </div>

      <div class="footerHints">
        Skratky: <span class="kbd">Enter</span> potvrƒè / ƒèal≈°ia ‚Ä¢ <span class="kbd">1‚Äì4</span> v√Ωber mo≈ænost√≠ ‚Ä¢ <span class="kbd">Space</span> flip/uk√°≈æ odpoveƒè ‚Ä¢ <span class="kbd">S</span> TTS
      </div>
    </div>

    <!-- RIGHT: DASHBOARD -->
    <div class="card">
      <h2>Dashboard</h2>

      <div class="statsGrid">
        <div class="stat">
          <div class="k">Dnes hotovo</div>
          <div class="v" id="statDone">0</div>
          <div class="mini" id="statDoneMini">z cieƒæa 20</div>
        </div>
        <div class="stat">
          <div class="k">Na dnes (due)</div>
          <div class="v" id="statDue">0</div>
          <div class="mini" id="statDueMini">v aktu√°lnom v√Ωbere</div>
        </div>
        <div class="stat">
          <div class="k">Presnos≈•</div>
          <div class="v" id="statAcc">0%</div>
          <div class="mini" id="statAccMini">v tejto rel√°cii</div>
        </div>
        <div class="stat">
          <div class="k">Cieƒæ na de≈à</div>
          <div class="v"><span id="statGoal">20</span></div>
          <div class="mini">
            <span class="muted">Nastav:</span>
            <input type="number" min="5" max="200" step="5" id="goalInput" value="20" />
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">Data a tr√©ning</div>
          <div class="muted2">SRS + ≈°tatistiky s√∫ ulo≈æen√© lok√°lne v prehliadaƒçi (localStorage).</div>
        </div>
        <div class="row">
          <button class="btn small" id="resetSessionBtn" title="Vynuluje len rel√°ciu (sk√≥re/poƒç√≠tadl√°)">Reset rel√°cie</button>
          <button class="btn small danger" id="wipeProgressBtn" title="Zma≈æe SRS progres (boxy) pre v≈°etky karty">Zma≈æ progres</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="muted" style="margin-bottom:10px">Packy (v aktu√°lnom datasete)</div>
      <ul class="list" id="packList"></ul>
    </div>
  </div>
</div>

<script>
/* =========================
   DATASET LOADING
========================= */
const DATASET_URL = "./wordflip_dataset_en_sk.json";

// Minimal fallback ‚Äì pou≈æije sa len ak JSON nejde naƒç√≠ta≈•
const DATASET_FALLBACK = [
  {"type":"vocab","pack":"colors","en":"red","sk":"ƒçerven√°"},
  {"type":"vocab","pack":"colors","en":"blue","sk":"modr√°"},
  {"type":"vocab","pack":"numbers","en":"one","sk":"jeden"},
  {"type":"vocab","pack":"numbers","en":"two","sk":"dva"},
  {"type":"phrase","pack":"phrases","en":"Hello!","sk":"Ahoj!"},
  {"type":"phrase","pack":"phrases","en":"How are you?","sk":"Ako sa m√°≈°?"}
];

let DATASET = [...DATASET_FALLBACK];

/* =========================
   STORAGE KEYS
========================= */
const STORAGE_SRS = "wordflip_srs_v1";          // progress map
const STORAGE_SETTINGS = "wordflip_settings_v1";
const STORAGE_DAILY = "wordflip_daily_v1";      // daily done
const STORAGE_SESSION = "wordflip_session_v1";  // session stats

/* =========================
   SRS (Leitner) settings
   box 1..5 => interval days
========================= */
const BOX_INTERVAL_DAYS = {1:0, 2:1, 3:3, 4:7, 5:14};

/* =========================
   STATE
========================= */
let settings = {
  pack: "all",
  type: "all",
  dir: "en2sk",
  studyMode: "mc",
  dedup: true,
  dueOnly: true,
  autoNext: true,
  goal: 20
};

let session = {
  startedAt: Date.now(),
  answered: 0,
  correct: 0,
  doneToday: 0
};

let pool = [];        // filtered & maybe due-only
let current = null;   // current item
let currentQA = null; // {q,a,dirUsed}
let options = [];     // mc options
let revealed = false; // answer shown?
let srsMap = {};      // key -> {box, dueTs, lastTs, streak}

/* =========================
   HELPERS
========================= */
function $(id){ return document.getElementById(id); }
function now(){ return Date.now(); }
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function normalize(s){
  return String(s ?? "").trim();
}
function normCompare(s){
  // tolerant compare for typing (lowercase, remove extra spaces)
  return normalize(s).toLowerCase().replace(/\s+/g,' ');
}
function packTitle(pack){
  return normalize(pack)
    .replace(/^ff3-/, 'FF3 ‚Äì ')
    .replace(/-/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}
function itemKey(it){
  // stable unique key for a "card"
  return `${normalize(it.type)}|${normalize(it.pack)}|${normalize(it.en)}|${normalize(it.sk)}`;
}
function safeParse(json, fallback){
  try{ return JSON.parse(json); }catch{ return fallback; }
}
function loadSettings(){
  const s = safeParse(localStorage.getItem(STORAGE_SETTINGS) || "null", null);
  if(s && typeof s === "object") settings = {...settings, ...s};
}
function saveSettings(){
  localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(settings));
}
function loadSrs(){
  srsMap = safeParse(localStorage.getItem(STORAGE_SRS) || "{}", {});
  if(!srsMap || typeof srsMap !== "object") srsMap = {};
}
function saveSrs(){
  localStorage.setItem(STORAGE_SRS, JSON.stringify(srsMap));
}
function loadDaily(){
  const daily = safeParse(localStorage.getItem(STORAGE_DAILY) || "{}", {});
  const key = todayKey();
  session.doneToday = Number(daily[key] || 0);
}
function incDaily(n=1){
  const daily = safeParse(localStorage.getItem(STORAGE_DAILY) || "{}", {});
  const key = todayKey();
  daily[key] = Number(daily[key] || 0) + n;
  localStorage.setItem(STORAGE_DAILY, JSON.stringify(daily));
  session.doneToday = daily[key];
}
function loadSession(){
  const s = safeParse(localStorage.getItem(STORAGE_SESSION) || "null", null);
  if(s && typeof s === "object"){
    // reset per refresh is fine; we keep minimal
  }
}
function resetSession(){
  session.answered = 0;
  session.correct = 0;
  session.startedAt = Date.now();
  revealed = false;
  updateDashboard();
}
function wipeProgress(){
  localStorage.removeItem(STORAGE_SRS);
  loadSrs();
  buildPoolAndUI();
  updateDashboard();
}

/* =========================
   DATASET UTIL
========================= */
function cleanDataset(raw){
  return raw.map(x => ({
    type: normalize(x.type),
    pack: normalize(x.pack),
    en: normalize(x.en),
    sk: normalize(x.sk),
  })).filter(x => (x.type === "vocab" || x.type === "phrase") && x.pack && x.en && x.sk);
}
function dedupDataset(list){
  const seen = new Set();
  const out = [];
  for(const it of list){
    const k = itemKey(it);
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(it);
  }
  return out;
}
function buildPackIndex(list){
  const map = new Map();
  for(const it of list){
    if(!map.has(it.pack)) map.set(it.pack, {pack: it.pack, title: packTitle(it.pack), count:0});
    map.get(it.pack).count += 1;
  }
  return Array.from(map.values()).sort((a,b)=>a.title.localeCompare(b.title,'sk'));
}

/* =========================
   SRS CORE
========================= */
function ensureSrs(it){
  const k = itemKey(it);
  if(!srsMap[k]){
    srsMap[k] = { box: 1, dueTs: 0, lastTs: 0, streak: 0 };
  }
  return srsMap[k];
}
function isDue(it){
  const rec = ensureSrs(it);
  return Number(rec.dueTs || 0) <= now();
}
function schedule(it, rating){
  // rating: again | hard | good | easy
  const rec = ensureSrs(it);
  rec.lastTs = now();

  if(rating === "again"){
    rec.box = 1;
    rec.streak = 0;
  } else if(rating === "hard"){
    rec.box = Math.max(1, rec.box); // keep
    rec.streak = Math.max(0, rec.streak);
  } else if(rating === "good"){
    rec.box = Math.min(5, rec.box + 1);
    rec.streak = (rec.streak || 0) + 1;
  } else if(rating === "easy"){
    rec.box = Math.min(5, rec.box + 2);
    rec.streak = (rec.streak || 0) + 1;
  }

  const days = BOX_INTERVAL_DAYS[rec.box] ?? 1;
  const ms = days * 24 * 60 * 60 * 1000;
  rec.dueTs = now() + ms;

  saveSrs();
}

/* =========================
   QA + DISTRACTORS
========================= */
function getQA(it, dir){
  let used = dir;
  if(dir === "mix") used = Math.random() < 0.5 ? "en2sk" : "sk2en";
  const q = (used === "en2sk") ? it.en : it.sk;
  const a = (used === "en2sk") ? it.sk : it.en;
  return { q, a, dirUsed: used };
}

function pickDistractors(correctAnswer, datasetAll, it, dirUsed){
  // Much better: same type first, same pack first
  const need = 4;
  const used = new Set([correctAnswer]);
  const out = [correctAnswer];

  const sameType = datasetAll.filter(x => x.type === it.type);
  const samePackSameType = sameType.filter(x => x.pack === it.pack);

  function maybePush(x){
    const cand = (dirUsed === "en2sk") ? x.sk : x.en;
    const v = normalize(cand);
    if(!v) return;
    if(used.has(v)) return;
    used.add(v);
    out.push(v);
  }

  // 1) prefer same pack + same type
  while(out.length < need && samePackSameType.length){
    const r = samePackSameType[Math.floor(Math.random()*samePackSameType.length)];
    maybePush(r);
  }

  // 2) then same type across dataset
  while(out.length < need && sameType.length){
    const r = sameType[Math.floor(Math.random()*sameType.length)];
    maybePush(r);
  }

  // 3) then anything
  while(out.length < need){
    const r = datasetAll[Math.floor(Math.random()*datasetAll.length)];
    maybePush(r);
    if(out.length === 1 && datasetAll.length === 1) break;
  }

  // shuffle
  out.sort(()=>Math.random()-0.5);
  return out;
}

/* =========================
   BUILD POOL
========================= */
function filterDataset(){
  const dedupOn = $("dedupToggle").checked;
  const base = dedupOn ? dedupDataset(DATASET) : DATASET;

  const pack = $("packSelect").value;
  const type = $("typeSelect").value;

  let list = base;

  if(type !== "all"){
    list = list.filter(x => x.type === type);
  }
  if(pack !== "all"){
    list = list.filter(x => x.pack === pack);
  }
  return { base, list };
}

function buildPoolAndUI(){
  const { base, list } = filterDataset();
  const dueOnly = $("dueOnlyToggle").checked;

  // ensure srs records exist (fast enough for ~800 items)
  for(const it of base) ensureSrs(it);
  saveSrs();

  pool = dueOnly ? list.filter(isDue) : list.slice();

  updatePills(base, list, pool);
  updatePackList(base);
  updateDashboard();
}

function countDue(list){
  let n = 0;
  for(const it of list) if(isDue(it)) n++;
  return n;
}

function updatePills(base, list, pool){
  $("pillDataset").textContent = `Polo≈æky: ${DATASET.length}`;
  const unique = dedupDataset(DATASET).length;
  $("pillUnique").textContent = `Unik√°tne: ${unique}`;
  const due = countDue(list);
  $("pillDue").textContent = `Na dnes: ${due}`;
}

function updatePackList(base){
  const packs = buildPackIndex(base);
  const ul = $("packList");
  ul.innerHTML = "";
  const typeFilter = $("typeSelect").value;

  packs.forEach(p => {
    // count due in this pack (respect type filter & dedup)
    const dedupOn = $("dedupToggle").checked;
    const base2 = dedupOn ? dedupDataset(DATASET) : DATASET;
    let items = base2.filter(x => x.pack === p.pack);
    if(typeFilter !== "all") items = items.filter(x => x.type === typeFilter);
    const due = countDue(items);

    const li = document.createElement("li");
    li.className = "li";
    li.innerHTML = `
      <div class="name">${p.title}</div>
      <div class="count">spolu ${items.length} ‚Ä¢ dnes ${due}</div>
    `;
    li.addEventListener("click", () => {
      $("packSelect").value = p.pack;
      settings.pack = p.pack;
      saveSettings();
      buildPoolAndUI();
    });
    ul.appendChild(li);
  });
}

/* =========================
   UI: PACK SELECT
========================= */
function buildPackSelect(){
  const sel = $("packSelect");
  sel.innerHTML = "";

  const dedupOn = $("dedupToggle").checked;
  const base = dedupOn ? dedupDataset(DATASET) : DATASET;
  const packs = buildPackIndex(base);

  const oAll = document.createElement("option");
  oAll.value = "all";
  oAll.textContent = "V≈°etko";
  sel.appendChild(oAll);

  packs.forEach(p => {
    const o = document.createElement("option");
    o.value = p.pack;
    o.textContent = `${p.title} (${p.count})`;
    sel.appendChild(o);
  });
}

/* =========================
   STUDY FLOW
========================= */
function setBadges(it){
  $("badgePack").textContent = `Pack: ${packTitle(it.pack)}`;
  $("badgeType").textContent = `Type: ${it.type}`;
  const rec = ensureSrs(it);
  $("badgeBox").textContent = `Box: ${rec.box} ‚Ä¢ due ${rec.dueTs ? new Date(rec.dueTs).toLocaleDateString('sk-SK') : 'today'}`;
}
function setProgressBadges(){
  const dueOnly = $("dueOnlyToggle").checked;
  const { list } = filterDataset();
  const dueCount = countDue(list);
  const done = session.doneToday;
  $("badgeProgress").textContent = `Dnes: ${Math.min(done, settings.goal)}/${settings.goal} ‚Ä¢ due ${dueCount}${dueOnly ? '' : ''}`;
  $("badgeScore").textContent = `Sk√≥re: ${session.correct}/${session.answered || 0}`;
}
function showReveal(answer, mini){
  $("revealAnswer").textContent = answer;
  $("revealMini").textContent = mini || "";
  $("revealBox").classList.add("show");
  revealed = true;
  $("srRow").style.display = "flex";
}
function hideReveal(){
  $("revealBox").classList.remove("show");
  revealed = false;
  $("srRow").style.display = "none";
}

function renderModeUI(){
  const mode = $("studyModeSelect").value;
  $("options").style.display = (mode === "mc") ? "grid" : "none";
  $("typingRow").style.display = (mode === "typing") ? "flex" : "none";
  // flip uses reveal + sr buttons
}

function pickNext(){
  buildPoolAndUI();
  if(pool.length === 0){
    $("question").textContent = "V tomto v√Ωbere nem√°≈° niƒç ‚Äûna dnes‚Äú. Vypni ‚ÄûLen na dnes‚Äú alebo zme≈à pack/typ.";
    $("options").innerHTML = "";
    $("typingInput").value = "";
    hideReveal();
    return;
  }
  current = pool[Math.floor(Math.random()*pool.length)];
  currentQA = getQA(current, $("dirSelect").value);
  hideReveal();
  renderModeUI();

  setBadges(current);
  setProgressBadges();

  $("question").textContent = currentQA.q;

  const mode = $("studyModeSelect").value;
  if(mode === "mc"){
    options = pickDistractors(currentQA.a, ( $("dedupToggle").checked ? dedupDataset(DATASET) : DATASET ), current, currentQA.dirUsed);
    renderOptions(options, currentQA.a);
  } else if(mode === "typing"){
    $("typingInput").value = "";
    $("typingInput").focus();
    $("options").innerHTML = "";
  } else {
    // flip
    $("options").innerHTML = "";
    showReveal("Klikni Space alebo ‚ÄûUk√°≈æ odpoveƒè‚Äú (v typing), potom ohodno≈•.", `Smer: ${currentQA.dirUsed.toUpperCase()}`);
    // but for flip we prefer reveal actual answer only when user flips
    $("revealAnswer").textContent = "‚Äî";
    $("revealMini").textContent = "Space = flip (uk√°≈æ odpoveƒè), potom Again/Hard/Good/Easy.";
  }
}

function renderOptions(opts, correct){
  const box = $("options");
  box.innerHTML = "";
  opts.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "opt";
    btn.innerHTML = `<span style="color:var(--muted);font-size:12px;margin-right:8px">${idx+1}</span>${opt}`;
    btn.addEventListener("click", () => checkMC(btn, opt, correct));
    box.appendChild(btn);
  });
}

function lockOptions(){
  Array.from(document.querySelectorAll(".opt")).forEach(b => b.disabled = true);
}

function checkMC(btn, choice, correct){
  lockOptions();
  session.answered += 1;

  if(choice === correct){
    btn.classList.add("correct");
    session.correct += 1;
    incDaily(1);
    // MC correct -> Good
    schedule(current, "good");
    showReveal(correct, `Spr√°vne ‚Ä¢ ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${packTitle(current.pack)} ‚Ä¢ ${current.type}`);
  } else {
    btn.classList.add("wrong");
    // highlight correct
    Array.from(document.querySelectorAll(".opt")).forEach(b => {
      if(b.textContent.replace(/^\d\s*/,'').trim() === correct) b.classList.add("correct");
    });
    // MC wrong -> Again
    schedule(current, "again");
    showReveal(correct, `Nespr√°vne ‚Ä¢ ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${packTitle(current.pack)} ‚Ä¢ ${current.type}`);
  }

  updateDashboard();
  setProgressBadges();

  if($("autoNextToggle").checked){
    setTimeout(() => pickNext(), 800);
  }
}

function levenshtein(a, b){
  // small & fast for short strings
  a = normCompare(a); b = normCompare(b);
  const m = a.length, n = b.length;
  if(m === 0) return n;
  if(n === 0) return m;
  const dp = Array.from({length:m+1}, () => new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + cost
      );
    }
  }
  return dp[m][n];
}

function checkTyping(){
  if(!current) return;
  const user = $("typingInput").value;
  const target = currentQA.a;

  session.answered += 1;

  const ua = normCompare(user);
  const ta = normCompare(target);

  // tolerate minor typos
  const dist = levenshtein(ua, ta);
  const ok = (ua === ta) || (dist <= Math.max(1, Math.floor(ta.length * 0.12)));

  if(ok){
    session.correct += 1;
    incDaily(1);
    schedule(current, "good");
    showReveal(target, `OK (tolerant) ‚Ä¢ vzdialenos≈• ${dist} ‚Ä¢ ${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${current.type}`);
  } else {
    schedule(current, "again");
    showReveal(target, `Nesed√≠ ‚Ä¢ vzdialenos≈• ${dist} ‚Ä¢ Sk√∫s znova zajtra`);
  }

  updateDashboard();
  setProgressBadges();

  if($("autoNextToggle").checked){
    setTimeout(() => pickNext(), 950);
  }
}

function flipReveal(){
  if(!current) return;
  // show real answer now
  showReveal(currentQA.a, `${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${packTitle(current.pack)} ‚Ä¢ ${current.type}`);
}

function rate(r){
  if(!current) return;
  // If in flip mode, rating is explicit.
  // If in typing mode and user requested show answer, rating required.
  schedule(current, r);
  if(r === "good" || r === "easy") incDaily(1); // counts as done
  updateDashboard();
  setProgressBadges();
  if($("autoNextToggle").checked){
    setTimeout(() => pickNext(), 500);
  }
}

/* =========================
   DASHBOARD
========================= */
function updateDashboard(){
  settings.goal = Number($("goalInput").value || 20);
  $("statGoal").textContent = settings.goal;

  $("statDone").textContent = session.doneToday;
  $("statDoneMini").textContent = `z cieƒæa ${settings.goal}`;

  const { list } = filterDataset();
  const due = countDue(list);
  $("statDue").textContent = due;
  $("statDueMini").textContent = `v aktu√°lnom v√Ωbere`;

  const acc = session.answered ? Math.round((session.correct/session.answered)*100) : 0;
  $("statAcc").textContent = `${acc}%`;
  $("statAccMini").textContent = `${session.correct}/${session.answered || 0} odpoved√≠ v rel√°cii`;
  setProgressBadges();
}

/* =========================
   TTS
========================= */
function ttsSpeak(text){
  const t = normalize(text);
  if(!t) return;
  if(!("speechSynthesis" in window)) { alert("TTS nie je podporovan√© v tomto prehliadaƒçi."); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(t);
  // heuristika: EN alebo SK podƒæa obsahu
  const hasCaron = /[√°√§ƒçƒè√©√≠ƒ∫ƒæ≈à√≥√¥≈ï≈°≈•√∫√Ω≈æ]/i.test(t);
  u.lang = hasCaron ? "sk-SK" : "en-US";
  u.rate = 0.95;
  u.pitch = 1.0;
  window.speechSynthesis.speak(u);
}

/* =========================
   INIT / EVENTS
========================= */
async function loadDataset(){
  try{
    const res = await fetch(DATASET_URL, { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.json();
    if(!Array.isArray(raw)) throw new Error("JSON nie je pole");
    DATASET = cleanDataset(raw);
    if(DATASET.length === 0) throw new Error("Dataset je pr√°zdny po ƒçisten√≠");
  } catch(e){
    console.warn("Dataset load failed, using fallback", e);
    DATASET = cleanDataset(DATASET_FALLBACK);
  }
}

function syncControlsFromSettings(){
  $("dedupToggle").checked = !!settings.dedup;
  $("dueOnlyToggle").checked = !!settings.dueOnly;
  $("autoNextToggle").checked = !!settings.autoNext;
  $("typeSelect").value = settings.type;
  $("dirSelect").value = settings.dir;
  $("studyModeSelect").value = settings.studyMode;
  $("goalInput").value = settings.goal;
}

function syncSettingsFromControls(){
  settings.pack = $("packSelect").value;
  settings.type = $("typeSelect").value;
  settings.dir = $("dirSelect").value;
  settings.studyMode = $("studyModeSelect").value;
  settings.dedup = $("dedupToggle").checked;
  settings.dueOnly = $("dueOnlyToggle").checked;
  settings.autoNext = $("autoNextToggle").checked;
  settings.goal = Number($("goalInput").value || 20);
  saveSettings();
}

function wireEvents(){
  $("startBtn").addEventListener("click", () => { syncSettingsFromControls(); pickNext(); });
  $("nextBtn").addEventListener("click", () => { syncSettingsFromControls(); pickNext(); });

  $("ttsBtn").addEventListener("click", () => {
    if(!currentQA) return;
    ttsSpeak(currentQA.q);
  });

  $("typeSelect").addEventListener("change", () => { syncSettingsFromControls(); buildPoolAndUI(); });
  $("dirSelect").addEventListener("change", () => { syncSettingsFromControls(); });
  $("studyModeSelect").addEventListener("change", () => { syncSettingsFromControls(); renderModeUI(); hideReveal(); });

  $("packSelect").addEventListener("change", () => { syncSettingsFromControls(); buildPoolAndUI(); });

  $("dedupToggle").addEventListener("change", () => {
    syncSettingsFromControls();
    buildPackSelect();
    // keep selected pack if exists
    if(settings.pack !== "all") $("packSelect").value = settings.pack;
    buildPoolAndUI();
  });

  $("dueOnlyToggle").addEventListener("change", () => { syncSettingsFromControls(); buildPoolAndUI(); });
  $("autoNextToggle").addEventListener("change", () => { syncSettingsFromControls(); });

  $("goalInput").addEventListener("change", () => { syncSettingsFromControls(); updateDashboard(); });

  $("resetSessionBtn").addEventListener("click", () => resetSession());
  $("wipeProgressBtn").addEventListener("click", () => {
    if(confirm("Zmaza≈• SRS progres pre v≈°etky karty? (boxy a due d√°tumy)")) wipeProgress();
  });

  $("checkTypingBtn").addEventListener("click", () => checkTyping());
  $("showAnswerBtn").addEventListener("click", () => {
    if(!current) return;
    showReveal(currentQA.a, `${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${packTitle(current.pack)} ‚Ä¢ ${current.type}`);
  });

  $("typingInput").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ checkTyping(); }
  });

  $("btnAgain").addEventListener("click", ()=>rate("again"));
  $("btnHard").addEventListener("click", ()=>rate("hard"));
  $("btnGood").addEventListener("click", ()=>rate("good"));
  $("btnEasy").addEventListener("click", ()=>rate("easy"));

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;

    const mode = $("studyModeSelect").value;

    if(e.key === "s" || e.key === "S"){
      if(currentQA) ttsSpeak(currentQA.q);
    }
    if(e.key === " "){
      e.preventDefault();
      if(mode === "flip"){
        if(!revealed || $("revealAnswer").textContent === "‚Äî") flipReveal();
      } else if(mode === "typing"){
        // show answer in typing
        if(current) showReveal(currentQA.a, `${currentQA.dirUsed.toUpperCase()} ‚Ä¢ ${packTitle(current.pack)} ‚Ä¢ ${current.type}`);
      }
    }
    if(mode === "mc"){
      if(["1","2","3","4"].includes(e.key)){
        const idx = Number(e.key) - 1;
        const btns = Array.from(document.querySelectorAll(".opt"));
        if(btns[idx] && !btns[idx].disabled) btns[idx].click();
      }
      if(e.key === "Enter"){
        // next
        pickNext();
      }
    } else {
      if(e.key === "Enter"){
        pickNext();
      }
    }
  });
}

(async function init(){
  loadSettings();
  await loadDataset();
  loadSrs();
  loadDaily();
  loadSession();

  syncControlsFromSettings();
  buildPackSelect();

  // set saved pack if possible
  if(settings.pack && settings.pack !== "all"){
    // if pack doesn't exist, fallback to all
    const exists = DATASET.some(x => x.pack === settings.pack);
    $("packSelect").value = exists ? settings.pack : "all";
  } else {
    $("packSelect").value = "all";
  }

  buildPoolAndUI();
  renderModeUI();
  wireEvents();

  // Initial pills/dashboard
  updateDashboard();
})();
</script>
</body>
</html>
